# ç ”ç©¶çº§æœºå™¨å­¦ä¹ æ¨¡å‹æ ‡å‡†åŒ–ä¿å­˜ç³»ç»Ÿ

## æ¦‚è¿°

æœ¬ç³»ç»Ÿä¸ºç ”ç©¶äººå‘˜æä¾›äº†ä¸€ä¸ªæ ‡å‡†åŒ–çš„æœºå™¨å­¦ä¹ æ¨¡å‹ä¿å­˜å’Œç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿æ¨¡å‹è®­ç»ƒç»“æœçš„å¯é‡ç”¨æ€§ã€å¯å®¡è®¡æ€§å’Œå®Œå…¨çš„å¯é‡ç°æ€§ã€‚

## å®ç°çš„åŠŸèƒ½

### ğŸ¯ æ ‡å‡†åŒ–æ–‡ä»¶æ ¼å¼

æ¯ä¸ªè®­ç»ƒå®Œæˆçš„æ¨¡å‹éƒ½å°†ä¿å­˜ä¸ºåŒ…å«ä»¥ä¸‹æ–‡ä»¶çš„å®Œæ•´åŒ…ï¼š

```
model_name_timestamp/
â”œâ”€â”€ model.joblib          # è®­ç»ƒå¥½çš„æ¨¡å‹å¯¹è±¡
â”œâ”€â”€ params.json          # è®­ç»ƒå‚æ•°å’Œé…ç½®
â”œâ”€â”€ metrics.json         # è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡
â”œâ”€â”€ metadata.json        # å®Œæ•´çš„å…ƒæ•°æ®ä¿¡æ¯
â”œâ”€â”€ features.json        # ç‰¹å¾åç§°å’Œä¿¡æ¯
â””â”€â”€ test_predictions.csv # æµ‹è¯•é›†é¢„æµ‹ç»“æœ
```

### ğŸ“Š è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡ (metrics.json)

åŒ…å«å…¨é¢çš„æ¨¡å‹è¯„ä¼°æŒ‡æ ‡ï¼š
- **æ•´ä½“æŒ‡æ ‡**: å‡†ç¡®ç‡ã€å®å¹³å‡å’ŒåŠ æƒå¹³å‡çš„ç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1åˆ†æ•°
- **ç±»åˆ«æŒ‡æ ‡**: æ¯ä¸ªç±»åˆ«çš„è¯¦ç»†æ€§èƒ½æŒ‡æ ‡
- **æ··æ·†çŸ©é˜µ**: å®Œæ•´çš„åˆ†ç±»æ··æ·†çŸ©é˜µ
- **æ•°æ®ç»Ÿè®¡**: æµ‹è¯•æ ·æœ¬æ•°ã€ç‰¹å¾æ•°ã€ç±»åˆ«æ•°

### âš™ï¸ è®­ç»ƒå‚æ•°è®°å½• (params.json)

ä¿å­˜å®Œæ•´çš„è®­ç»ƒé…ç½®ï¼š
- **æ¨¡å‹å‚æ•°**: æ‰€æœ‰æ¨¡å‹è¶…å‚æ•°
- **ç®¡é“é…ç½®**: å®Œæ•´çš„sklearnç®¡é“ä¿¡æ¯
- **è®­ç»ƒé…ç½®**: äº¤å‰éªŒè¯ã€ç½‘æ ¼æœç´¢å‚æ•°
- **æœ€ä½³å‚æ•°**: ç½‘æ ¼æœç´¢æ‰¾åˆ°çš„æœ€ä½³å‚æ•°ç»„åˆ
- **è®­ç»ƒæ—¶é—´**: è¯¦ç»†çš„è®­ç»ƒè€—æ—¶ç»Ÿè®¡

### ğŸ“‹ å®Œæ•´å…ƒæ•°æ® (metadata.json)

ç¡®ä¿å®Œå…¨å¯é‡ç°æ€§çš„å…ƒæ•°æ®ï¼š
- **æ¨¡å‹ä¿¡æ¯**: æ¨¡å‹ç±»å‹ã€åˆ›å»ºæ—¶é—´ã€ç‰ˆæœ¬ä¿¡æ¯
- **æ•°æ®ä¿¡æ¯**: æ ·æœ¬æ•°ã€ç‰¹å¾æ•°ã€ç±»åˆ«åˆ†å¸ƒ
- **ç¯å¢ƒä¿¡æ¯**: Pythonç‰ˆæœ¬ã€scikit-learnç‰ˆæœ¬
- **ç ”ç©¶ä¿¡æ¯**: é¡¹ç›®åç§°ã€ä½œè€…ã€ç ”ç©¶é—®é¢˜æè¿°

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨ - å¿«é€Ÿä¿å­˜

```python
from mch.utils.model_persistence import save_research_model

# è®­ç»ƒå®Œæ¨¡å‹åï¼Œä¸€è¡Œä»£ç ä¿å­˜
saved_dir = save_research_model(
    model=trained_model,
    model_name="methylation_classifier",
    X_test=X_test,
    y_test=y_test,
    save_directory="results/models"
)
```

### 2. é«˜çº§ä½¿ç”¨ - å®Œæ•´é…ç½®

```python
from mch.utils.model_persistence import ModelPersistence

persistence = ModelPersistence("results/models")

saved_dir = persistence.save_model_complete(
    model=trained_model,
    model_name="hierarchical_classifier",
    X_test=X_test,
    y_test=y_test,
    training_params={
        "model_type": "svm",
        "cross_validation_folds": 5,
        "feature_selection": "differential_methylation"
    },
    feature_names=feature_list,
    class_names=cancer_types,
    additional_metadata={
        "research_question": "Hierarchical cancer classification",
        "data_freeze": "freeze0525",
        "notes": "Using methylation data for cancer subtype prediction"
    }
)
```

### 3. æ¨¡å‹åŠ è½½å’Œå®¡è®¡

```python
from mch.utils.model_persistence import load_research_model

# åŠ è½½å®Œæ•´çš„æ¨¡å‹åŒ…
package = load_research_model("results/models/model_20251015_182020")

# è·å–æ¨¡å‹
model = package["model"]

# æŸ¥çœ‹è®­ç»ƒå‚æ•°
training_params = package["params"]

# æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
metrics = package["metrics"]
print(f"Accuracy: {metrics['accuracy']:.3f}")

# æŸ¥çœ‹å…ƒæ•°æ®
metadata = package["metadata"]
print(f"Created: {metadata['creation_timestamp']}")
```

## é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

### å¢å¼ºçš„æ¨¡å‹è®­ç»ƒç®¡é“

åŸæœ‰çš„ `generate_model_for_node` å‡½æ•°å·²å‡çº§ä¸ºä½¿ç”¨æ ‡å‡†åŒ–ä¿å­˜ï¼š

```python
# ç°åœ¨è®­ç»ƒå®Œæˆåè‡ªåŠ¨ä¿å­˜æ ‡å‡†æ ¼å¼
saved_model_dir = generate_model_for_node(disease_tree_node, results_dir)

# ä¿å­˜çš„æ¨¡å‹åŒ…å«ï¼š
# - model.joblib: å®Œæ•´çš„sklearnç®¡é“
# - params.json: ç½‘æ ¼æœç´¢æœ€ä½³å‚æ•°å’Œè®­ç»ƒé…ç½®
# - metrics.json: åœ¨æµ‹è¯•é›†ä¸Šçš„è¯¦ç»†æ€§èƒ½è¯„ä¼°
# - metadata.json: å®éªŒå…ƒæ•°æ®å’Œæ•°æ®æè¿°
```

## ç ”ç©¶ä¼˜åŠ¿

### âœ… å®Œå…¨å¯é‡ç°

- æ‰€æœ‰è®­ç»ƒå‚æ•°è¢«å®Œæ•´è®°å½•
- æ•°æ®ç‰ˆæœ¬å’Œé¢„å¤„ç†æ­¥éª¤è¢«è¿½è¸ª
- ç¯å¢ƒä¿¡æ¯è¢«ä¿å­˜ä»¥ç¡®ä¿å¯é‡ç°æ€§

### âœ… æ˜“äºæ¯”è¾ƒ

- æ ‡å‡†åŒ–çš„æŒ‡æ ‡æ ¼å¼ä¾¿äºæ¨¡å‹é—´æ¯”è¾ƒ
- ä¸€è‡´çš„æ–‡ä»¶ç»“æ„æ”¯æŒè‡ªåŠ¨åŒ–åˆ†æ
- æµ‹è¯•é›†é¢„æµ‹ç»“æœå¯ç”¨äºåç»­åˆ†æ

### âœ… å®¡è®¡å‹å¥½

- å®Œæ•´çš„è®­ç»ƒè¿‡ç¨‹è®°å½•
- æ¨¡å‹å†³ç­–çš„å¯è¿½æº¯æ€§
- ç¬¦åˆç ”ç©¶æ ‡å‡†çš„æ–‡æ¡£åŒ–

### âœ… å›¢é˜Ÿåä½œ

- æ ‡å‡†åŒ–æ ¼å¼ä¾¿äºå›¢é˜Ÿæˆå‘˜ç†è§£
- å®Œæ•´çš„å…ƒæ•°æ®æ”¯æŒçŸ¥è¯†ä¼ é€’
- ç‰ˆæœ¬åŒ–çš„æ¨¡å‹ç®¡ç†

## æ¼”ç¤ºè„šæœ¬

è¿è¡Œä»¥ä¸‹è„šæœ¬æŸ¥çœ‹ç³»ç»Ÿæ¼”ç¤ºï¼š

```bash
# æµ‹è¯•ç³»ç»Ÿè®¾ç½®
python test_research_setup.py

# è¿è¡Œå®Œæ•´æ¼”ç¤º
python demo_research_saving.py

# æŸ¥çœ‹ä¿å­˜çš„æ–‡ä»¶
ls results/demo_research_models/demo_methylation_classifier_*/
```

## é…ç½®æ–‡ä»¶

ç³»ç»Ÿä½¿ç”¨ä»¥ä¸‹é…ç½®æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼š

- `src/mch/config/base_config.yaml`: åŸºç¡€è·¯å¾„å’Œæ•°æ®é…ç½®
- `src/mch/config/modelTrainingConfig.yaml`: æ¨¡å‹è®­ç»ƒå‚æ•°
- `data/colorProfiles.json`: å¯è§†åŒ–é¢œè‰²é…ç½®

## ä¸‹ä¸€æ­¥

1. **é›†æˆåˆ°ç”Ÿäº§ç¯å¢ƒ**: å°†æ ‡å‡†åŒ–ä¿å­˜é›†æˆåˆ°ç°æœ‰çš„æ¨¡å‹è®­ç»ƒæµç¨‹
2. **æ‰©å±•æŒ‡æ ‡**: æ·»åŠ æ›´å¤šé¢†åŸŸç‰¹å®šçš„è¯„ä¼°æŒ‡æ ‡
3. **å¯è§†åŒ–å·¥å…·**: å¼€å‘è‡ªåŠ¨åŒ–çš„æ¨¡å‹æ€§èƒ½å¯è§†åŒ–å·¥å…·
4. **ç‰ˆæœ¬ç®¡ç†**: å®ç°æ¨¡å‹ç‰ˆæœ¬çš„è‡ªåŠ¨åŒ–ç®¡ç†ç³»ç»Ÿ

## æ³¨æ„äº‹é¡¹

- æ¨¡å‹ä¿å­˜æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„ç›®å½•ï¼Œé¿å…è¦†ç›–
- JSONæ–‡ä»¶ä½¿ç”¨å¯è¯»æ€§è‰¯å¥½çš„ç¼©è¿›æ ¼å¼
- å¤§å‹æ¨¡å‹ä¼šè¢«å‹ç¼©ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´
- æ‰€æœ‰numpyå’Œpandaså¯¹è±¡ä¼šè¢«é€‚å½“åºåˆ—åŒ–

è¿™ä¸ªç³»ç»Ÿç¡®ä¿æ‚¨çš„ç ”ç©¶æ¨¡å‹å§‹ç»ˆä»¥æ ‡å‡†ã€å¯å®¡è®¡çš„æ–¹å¼ä¿å­˜ï¼Œæ”¯æŒç ”ç©¶çš„å¯é‡ç°æ€§å’Œç»“æœçš„å¯ä¿¡åº¦ã€‚